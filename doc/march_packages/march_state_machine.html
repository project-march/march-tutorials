

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>march_state_machine &mdash; Project March Melodic documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/override.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'Melodic',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="march_gait_selection" href="march_gait_selection.html" />
    <link rel="prev" title="march_shared_resources" href="march_shared_resources.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/create_your_workspace.html">Create your workspace</a></li>
</ul>
<p class="caption"><span class="caption-text">Useful tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/robot_model.html">Robot model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/ros_control.html">ros_control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/rqt.html">RQT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/ros_bag.html">ROS bag</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/gazebo.html">Gazebo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/smach.html">SMACH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/event_stream_processing.html">Event stream Processing</a></li>
</ul>
<p class="caption"><span class="caption-text">Using the March Exoskeleton</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/high_level_overview.html">High level overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/connecting_to_the_exoskeleton.html">Connecting to the exoskeleton</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/how_to_airgait.html">How to airgait</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/how_to_view_live_data.html">How to view live data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/log_files.html">Log files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/using_the_gait_generator.html">Using the gait generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/error_codes.html">Error Codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/using_the_pressure_soles.html">Using the pressure soles</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../continuous_integration/continuous_integration.html">Continuous Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/style_guide.html">Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/add_a_new_gait.html">Add a new gait</a></li>
</ul>
<p class="caption"><span class="caption-text">March Packages</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="march_data_collector.html">march_data_collector</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_description.html">march_description</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_fake_sensor_data.html">march_fake_sensor_data</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_gain_scheduling.html">march_gain_scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_gait_files.html">march_gait_files</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_hardware.html">march_hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_hardware_builder.html">march_hardware_builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_hardware_interface.html">march_hardware_interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_imu_manager.html">march_imu_manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_input_device.html">march_input_device</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_launch.html">march_launch</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_rqt_input_device.html">march_rqt_input_device</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_safety.html">march_safety</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_shared_classes.html">march_shared_classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_shared_resources.html">march_shared_resources</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">march_state_machine</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#behavior">Behavior</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#launch">LAUNCH</a></li>
<li class="toctree-l3"><a class="reference internal" href="#healthy">HEALTHY</a></li>
<li class="toctree-l3"><a class="reference internal" href="#error">ERROR</a></li>
<li class="toctree-l3"><a class="reference internal" href="#shutdown">SHUTDOWN</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ros-api">ROS API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#nodes">Nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#subscribed-topics">Subscribed Topics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#published-topics">Published Topics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#services">Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parameters">Parameters</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tutorials">Tutorials</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#add-a-state-to-the-state-machine">Add a state to the state machine</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="march_gait_selection.html">march_gait_selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_simulation.html">march_simulation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Project March</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>march_state_machine</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/project-march/tutorials/blob/master/doc/march_packages/march_state_machine.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="march-state-machine">
<span id="march-state-machine-label"></span><h1>march_state_machine<a class="headerlink" href="#march-state-machine" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The march_state_machine contains the general behavior of the March exoskeleton. Simply
put, after launching the exoskeleton the state machine decides which gaits
can be performed. The state machine also knows which gait can be executed in
every possible state. For example after sitting you can stand-up, but you
cannot walk.</p>
<p>We are using a hierarchical state machine, which is a state machine whose
states can be state machines as well. We also use SMACH, this is a task-level
architecture for rapidly creating complex robot behavior(see <a class="reference internal" href="../useful_tools/smach.html#smach-label"><span class="std std-ref">SMACH</span></a>).</p>
</div>
<div class="section" id="behavior">
<h2>Behavior<a class="headerlink" href="#behavior" title="Permalink to this headline">¶</a></h2>
<p>There are 4 general states in the state machine: <strong>LAUNCH</strong>, <strong>HEALTHY</strong>,
<strong>SHUTDOWN</strong>, <strong>ERROR</strong>, where <strong>LAUNCH</strong> and <strong>HEALTHY</strong> are also state
machines. As mentioned above, this is possible in a hierarchical state machine.</p>
<div class="figure align-center">
<img alt="../../_images/march_state_machine.png" src="../../_images/march_state_machine.png" />
</div>
<p>The above image is a screenshot from the
<a class="reference external" href="https://wiki.ros.org/smach_viewer">smach_viewer</a>. This visualizes the states
of the state machine and makes active ones green. This screenshot only shows
the high level states. The smach_viewer can be launched with the
<code class="docutils literal"><span class="pre">state_machine_viewer</span></code> launch argument, which defaults to <code class="docutils literal"><span class="pre">false</span></code>.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">roslaunch</span> <span class="n">march_state_machine</span> <span class="n">state_machine</span><span class="o">.</span><span class="n">launch</span> <span class="n">state_machine_viewer</span><span class="p">:</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>When you get an error saying that it failed to load Gtk, you need to install
<code class="docutils literal"><span class="pre">python-gi-cairo</span></code> from the Ubuntu repositories:</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">gi</span><span class="o">-</span><span class="n">cairo</span>
</pre></div>
</div>
<p class="last">See <a class="reference external" href="https://github.com/ros-visualization/executive_smach_visualization/issues/20">https://github.com/ros-visualization/executive_smach_visualization/issues/20</a>
for more info.</p>
</div>
<div class="section" id="launch">
<h3>LAUNCH<a class="headerlink" href="#launch" title="Permalink to this headline">¶</a></h3>
<p>Launch starts with a <strong>WAIT FOR GAIT SERVER</strong> state. This state waits for the
gait selection server to be available, since that is where the state machine
sends requests for executing gaits.</p>
</div>
<div class="section" id="healthy">
<h3>HEALTHY<a class="headerlink" href="#healthy" title="Permalink to this headline">¶</a></h3>
<p>When launched successful the <strong>HEALTHY</strong> state machine is active. This part
contains all possible gaits. Besides gaits, we also have <em>idle</em> states such as
<strong>STANDING</strong>, <strong>SITTING</strong> and <strong>UNKNOWN</strong>. <strong>UNKNOWN</strong> is the state in which
the current position is not known. This can be on start-up, but also after an
error is thrown and the March exoskeleton did not fully execute the intended gait.
Transitions between <em>idle-states</em> to <em>gait-states</em> are present only when it
is safe to execute this gait at that moment. For example, from the idle state
<strong>SITTING</strong> you can only stand-up.</p>
<p>In this state machine the <strong>SAFETY</strong> state is always active. However, this is
not the only active state. Multiple active states at the same time are called
<a class="reference external" href="http://wiki.ros.org/smach/Tutorials/Concurrent%20States">concurrent states</a>.
The <strong>SAFETY</strong> state is responsible for monitoring possible errors
(see <a class="reference internal" href="march_safety.html#march-safety-label"><span class="std std-ref">march_safety</span></a>). This is done in a concurrent state and can
preempt any active state in the <strong>HEALTHY</strong> state machine when a fatal error
occurs.</p>
</div>
<div class="section" id="error">
<h3>ERROR<a class="headerlink" href="#error" title="Permalink to this headline">¶</a></h3>
<p>After an error is thrown (see <a class="reference internal" href="march_safety.html#march-safety-label"><span class="std std-ref">march_safety</span></a> when this happens),
<strong>SAFETY</strong> state preempts the <strong>HEALTHY</strong> state and <strong>ERROR</strong> will become
active. For now the <strong>ERROR</strong> state will automatically go to <strong>SHUTDOWN</strong>,
but could be used later to recover from errors.</p>
</div>
<div class="section" id="shutdown">
<h3>SHUTDOWN<a class="headerlink" href="#shutdown" title="Permalink to this headline">¶</a></h3>
<p><strong>SHUTDOWN</strong> shuts down ROS when it was called, without ROS being shutdown.
Furthermore, it tries to kill the Gazebo server sending a <code class="docutils literal"><span class="pre">SIGTERM</span></code>, since
Gazebo has trouble shutting down by itself.</p>
</div>
</div>
<div class="section" id="ros-api">
<h2>ROS API<a class="headerlink" href="#ros-api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="nodes">
<h3>Nodes<a class="headerlink" href="#nodes" title="Permalink to this headline">¶</a></h3>
<p><em>march_state_machine</em> - Launches the state machine and keeps track of states.</p>
</div>
<div class="section" id="subscribed-topics">
<h3>Subscribed Topics<a class="headerlink" href="#subscribed-topics" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><em>/march/input_device/instruction</em> (<a class="reference external" href="https://github.com/project-march/march/tree/develop/march_shared_resources/msg/GaitInstruction.msg">march_shared_resources/GaitInstruction</a>)</dt>
<dd>Listens for instructions and executes them when there are possible state transitions.</dd>
</dl>
</div>
<div class="section" id="published-topics">
<h3>Published Topics<a class="headerlink" href="#published-topics" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><em>/march/gait/current</em> (<a class="reference external" href="https://docs.ros.org/melodic/api/std_msgs/html/msg/String.html">std_msgs/String</a>)</dt>
<dd>Publishes the current active gait once when it starts.</dd>
<dt><em>/march/input_device/instruction_response</em> (<a class="reference external" href="https://github.com/project-march/march/tree/develop/march_shared_resources/msg/GaitInstructionResponse.msg">march_shared_resources/GaitInstructionResponse</a>)</dt>
<dd>Publishes whether a gait was accepted, rejected or finished.</dd>
</dl>
</div>
<div class="section" id="services">
<h3>Services<a class="headerlink" href="#services" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><em>/march/state_machine/get_possible_gaits</em> (<a class="reference external" href="https://github.com/project-march/march/tree/develop/march_shared_resources/srv/PossibleGaits.srv">march_shared_resources/PossibleGaits</a>)</dt>
<dd>Returns a list of names of possible gaits than can be executed next.</dd>
<dt><em>/march/state_machine/current_states</em> (<a class="reference external" href="https://github.com/project-march/march/tree/develop/march_shared_resources/srv/CurrentState.srv">march_shared_resources/CurrentState</a>)</dt>
<dd>Returns the current active state and its type.</dd>
</dl>
</div>
<div class="section" id="parameters">
<h3>Parameters<a class="headerlink" href="#parameters" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><em>state_machine/state_machine_viewer</em> (<em>bool</em>, default: <code class="docutils literal"><span class="pre">false</span></code>)</dt>
<dd>Whether to launch the smach_viewer.</dd>
<dt><em>state_machine/unpause</em> (<em>bool</em>, default: <code class="docutils literal"><span class="pre">true</span></code>)</dt>
<dd>Unpauses the simulation, since the Gazebo simulation always starts paused.</dd>
<dt><em>state_machine/sounds</em> (<em>bool</em>, default: <code class="docutils literal"><span class="pre">false</span></code>)</dt>
<dd>Whether to play sounds using the soundplay_node.</dd>
</dl>
</div>
</div>
<div class="section" id="tutorials">
<h2>Tutorials<a class="headerlink" href="#tutorials" title="Permalink to this headline">¶</a></h2>
<div class="section" id="add-a-state-to-the-state-machine">
<h3>Add a state to the state machine<a class="headerlink" href="#add-a-state-to-the-state-machine" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference internal" href="../development/add_a_new_gait.html#add-gait-label"><span class="std std-ref">Add a new gait</span></a> on how to add a gait state to the <strong>HEALTY</strong> state machine. Adding other non-gait states is similar.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="march_gait_selection.html" class="btn btn-neutral float-right" title="march_gait_selection" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="march_shared_resources.html" class="btn btn-neutral float-left" title="march_shared_resources" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Project March
      <span class="lastupdated">
        Last updated on Jul 29, 2020.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>