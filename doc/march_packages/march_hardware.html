

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>march_hardware &mdash; Project March Melodic documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'Melodic',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="march_hardware_builder" href="march_hardware_builder.html" />
    <link rel="prev" title="march_gait_files" href="march_gait_files.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/create_your_workspace.html">Create your workspace</a></li>
</ul>
<p class="caption"><span class="caption-text">Useful tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/robot_model.html">Robot model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/ros_control.html">ros_control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/rqt.html">RQT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/ros_bag.html">ROS bag</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/gazebo.html">Gazebo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/smach.html">SMACH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/event_stream_processing.html">Event stream Processing</a></li>
</ul>
<p class="caption"><span class="caption-text">Using the March Exoskeleton</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/high_level_overview.html">High level overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/connecting_to_the_exoskeleton.html">Connecting to the exoskeleton</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/how_to_airgait.html">How to airgait</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/how_to_view_live_data.html">How to view live data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/log_files.html">Log files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/using_the_gait_generator.html">Using the gait generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/error_codes.html">Error Codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/using_the_pressure_soles.html">Using the pressure soles</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../continuous_integration/continuous_integration.html">Continuous Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/style_guide.html">Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/add_a_new_gait.html">Add a new gait</a></li>
</ul>
<p class="caption"><span class="caption-text">March Packages</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="march_data_collector.html">march_data_collector</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_description.html">march_description</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_fake_sensor_data.html">march_fake_sensor_data</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_gait_files.html">march_gait_files</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">march_hardware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#class-structure">Class Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-usage">Example usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ethercat">EtherCAT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ethercatmaster">EthercatMaster</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pdo-messages">PDO messages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sdo-messages">SDO messages</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#power-distribution-board">Power Distribution Board</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exceptions">Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ros-api">ROS API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="march_hardware_builder.html">march_hardware_builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_hardware_interface.html">march_hardware_interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_imu_manager.html">march_imu_manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_input_device.html">march_input_device</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_launch.html">march_launch</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_rqt_input_device.html">march_rqt_input_device</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_rqt_software_check.html">march_rqt_software_check</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_safety.html">march_safety</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_shared_classes.html">march_shared_classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_shared_resources.html">march_shared_resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_state_machine.html">march_state_machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_gait_selection.html">march_gait_selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_simulation.html">march_simulation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Project March</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>march_hardware</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/project-march/tutorials/blob/master/doc/march_packages/march_hardware.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="march-hardware">
<span id="march-hardware-label"></span><h1>march_hardware<a class="headerlink" href="#march-hardware" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The march_hardware package is a C++ library to interact with the physical
March exoskeleton. Its goal is to provide an api for actuating the exoskeleton without
knowledge of the underlying hardware.</p>
</div>
<div class="section" id="class-structure">
<h2>Class Structure<a class="headerlink" href="#class-structure" title="Permalink to this headline">¶</a></h2>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The <a class="reference internal" href="march_hardware_builder.html#march-hardware-builder-label"><span class="std std-ref">march_hardware_builder</span></a> can help with the class structure of
the hardware package, especially when looking at an
<a class="reference external" href="https://github.com/project-march/hardware-interface/tree/develop/march_hardware_builder/robots/march4.yaml">example yaml</a>.</p>
</div>
<p>The highest level class is the MarchRobot, it contains a list of Joints, which
can be accessed. Each Joint is identified by a name and optionally has an
IMotionCube and TemperatureGES. This is enough knowledge to start interacting
with the robot.</p>
</div>
<div class="section" id="example-usage">
<h2>Example usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h2>
<p>Here is an example of the commands you can use on a MarchRobot object when it is
created with the correct joints.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">MarchRobot</span> <span class="n">robot</span><span class="p">;</span>  <span class="c1">// This step should use the hardware builder, but uses this to simplify the example</span>
<span class="n">robot</span><span class="p">.</span><span class="n">startEthercat</span><span class="p">();</span>
<span class="n">Joint</span><span class="o">&amp;</span> <span class="n">right_knee</span> <span class="o">=</span> <span class="n">robot</span><span class="p">.</span><span class="n">getJoint</span><span class="p">(</span><span class="s">&quot;right_knee&quot;</span><span class="p">);</span>
<span class="n">right_knee</span><span class="p">.</span><span class="n">prepareActuation</span><span class="p">();</span>
<span class="n">right_knee</span><span class="p">.</span><span class="n">actuateRad</span><span class="p">(</span><span class="mf">0.2</span><span class="p">);</span>
<span class="kt">double</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">right_knee</span><span class="p">.</span><span class="n">getAngleRadAbsolute</span><span class="p">();</span>
<span class="kt">float</span> <span class="n">temperature</span> <span class="o">=</span> <span class="n">right_knee</span><span class="p">.</span><span class="n">getTemperature</span><span class="p">();</span>
<span class="n">robot</span><span class="p">.</span><span class="n">stopEthercat</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="ethercat">
<h2>EtherCAT<a class="headerlink" href="#ethercat" title="Permalink to this headline">¶</a></h2>
<p>EtherCAT is the fieldbus protocol used to communicate with the local hardware
(‘slaves’) in the exoskeleton. <a class="reference external" href="https://github.com/OpenEtherCATsociety/SOEM">SOEM</a>
(short for Simple Open EtherCAT Master) is a C library which provides most
EtherCAT functionalities. As said, the hardware package is mainly a class
structure on top of SOEM functioning as an api for controlling the exoskeleton.
The interfaces can be roughly divided into three parts:</p>
<ul class="simple">
<li>EthercatMaster</li>
<li>PDO messages</li>
<li>SDO messages</li>
</ul>
<div class="section" id="ethercatmaster">
<h3>EthercatMaster<a class="headerlink" href="#ethercatmaster" title="Permalink to this headline">¶</a></h3>
<p>The EthercatMaster class contains the main EtherCAT functionality and the main
interface with SOEM. EtherCAT can be started and stopped via the EthercatMaster.
When EtherCAT is started, a parallel thread is started that continuously sends
and receives the latest EtherCAT PDO data and monitors if all slaves are still
present and operational. When EtherCAT is stopped, this parallel thread stops
running.</p>
<p>The EthercatMaster class expects several arguments in its constructor: the
network interface name (ifname) of your device, the number of EtherCAT slaves in
your robot, and the cycle time of the EtherCAT thread in milliseconds. An
example is provided below.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">EthercatMaster</span> <span class="nf">ethercat</span><span class="p">(</span><span class="s">&quot;enp2s0&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// 14 slaves, 2 ms cycle time</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Find out the ifname of your device by running <code class="code docutils literal"><span class="pre">ifconfig</span></code> in a terminal.</p>
</div>
</div>
<div class="section" id="pdo-messages">
<h3>PDO messages<a class="headerlink" href="#pdo-messages" title="Permalink to this headline">¶</a></h3>
<p>Process Data Objects (PDOs) are the cyclic and continuous type of messages of
EtherCAT, and the main form of exchanging data with the slaves. Reading and
writing EtherCAT PDO messages is possible through the other classes in the
march_hardware package (e.g. Joint, IMotionCube, Encoder, PowerDistributionBoard).
For example, the <a class="reference external" href="https://github.com/project-march/hardware-interface/tree/develop/march_hardware/include/march_hardware/encoder/Encoder.h">Encoder class</a>
<code class="docutils literal"><span class="pre">getAngleIU()</span></code> function reads and returns the latest encoder value that was
received by the EthercatMaster. Functions such as <code class="docutils literal"><span class="pre">getAngleIU()</span></code> all call the
same generic functions for reading from and writing to slaves. These generic
functions are defined in <a class="reference external" href="https://github.com/project-march/hardware-interface/tree/develop/march_hardware/src/EtherCAT/EthercatIO.cpp">EthercatIO.cpp</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>When reading or writing PDO messages over EtherCAT via SOEM, you need three
things:</p>
<ul class="simple">
<li>The index of the slave you want to read from or write to.</li>
<li>The amount of bytes you want to read or write.</li>
<li>The byte offset of the data you want to read or write for a particular slave.</li>
</ul>
<p class="last">The byte offsets need to correspond with how the slave is configured. For GES
and PDB slaves, this is stored in the EEPROM of the slave. For the IMotionCube,
this is configurable during startup through a process called PDO mapping.</p>
</div>
</div>
<div class="section" id="sdo-messages">
<h3>SDO messages<a class="headerlink" href="#sdo-messages" title="Permalink to this headline">¶</a></h3>
<p>Service Data Objects (SDOs) are non-cyclic EtherCAT messages. They are used for
sending one-time messages, for example when initializing an IMotionCube.
The generic SDO messaging functions can be found in <a class="reference external" href="https://github.com/project-march/hardware-interface/tree/develop/march_hardware/src/EtherCAT/EthercatSDO.cpp">EthercatSDO.cpp</a>.</p>
</div>
</div>
<div class="section" id="power-distribution-board">
<h2>Power Distribution Board<a class="headerlink" href="#power-distribution-board" title="Permalink to this headline">¶</a></h2>
<p>The PowerDistributionBoard class contains all functionality for communicating
with the Power Distribution Board over EtherCAT. For example, high voltage nets
can be turned on and off via this class, and the currents that the Power
Distribution Board measures can be read. The PowerDistributionBoard class
contains a HighVoltage and a LowVoltage class which contain methods for
controlling the high voltage and low voltage nets.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span><span class="n">PowerDistributionBoard</span> <span class="n">pdb</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">current</span> <span class="o">=</span> <span class="n">pdb</span><span class="p">.</span><span class="n">getPowerDistributionBoardCurrent</span><span class="p">();</span>
<span class="n">pdb</span><span class="p">.</span><span class="n">getHighVoltage</span><span class="p">().</span><span class="n">setNetOnOff</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// Turn on net 2</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The PowerDistributionBoard constructor requires EtherCAT byte offsets as
arguments. These need to be specified in the robot description yaml files of
the hardware_builder package.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The functionality of the PowerDistributionBoard is highly dependent on the
software running on the LPC1768 of the Power Distribution Board. See the
<a class="reference external" href="https://github.com/project-march/ethercat-slaves/tree/develop/src/pdb">ethercat-slaves repository</a> for the LPC1768 code.</p>
</div>
</div>
<div class="section" id="exceptions">
<h2>Exceptions<a class="headerlink" href="#exceptions" title="Permalink to this headline">¶</a></h2>
<p>Because safety is very important, the march_hardware package will throw an
exception whenever it encounters something that should not happen. The
march_hardware package implements custom exceptions in the
<a class="reference external" href="https://github.com/project-march/hardware-interface/tree/develop/march_hardware/include/march_hardware/error">error module</a>
with error types for different situations. See <a class="reference internal" href="../using_the_march_exoskeleton/error_codes.html#error-codes"><span class="std std-ref">Error Codes</span></a> for all types
of errors and how to possibly fix them. When such an exception occurs, the high
voltage is turned off and the exoskeleton will stop moving.</p>
</div>
<div class="section" id="ros-api">
<h2>ROS API<a class="headerlink" href="#ros-api" title="Permalink to this headline">¶</a></h2>
<p>The hardware package is written without depending on ROS to ensure that it can
remain functional even when ROS will no longer be used. The package does depend
on ROS for logging, but that can be easily changed if needed.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="march_hardware_builder.html" class="btn btn-neutral float-right" title="march_hardware_builder" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="march_gait_files.html" class="btn btn-neutral float-left" title="march_gait_files" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Project March
      <span class="lastupdated">
        Last updated on Apr 15, 2020.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>