

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>march_safety &mdash; Project March Melodic documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'Melodic',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="march_shared_classes" href="march_shared_classes.html" />
    <link rel="prev" title="march_rqt_software_check" href="march_rqt_software_check.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/create_your_workspace.html">Create your workspace</a></li>
</ul>
<p class="caption"><span class="caption-text">Useful tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/robot_model.html">Robot model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/ros_control.html">ros_control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/rqt.html">RQT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/ros_bag.html">ROS bag</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/gazebo.html">Gazebo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/smach.html">SMACH</a></li>
<li class="toctree-l1"><a class="reference internal" href="../useful_tools/event_stream_processing.html">Event stream Processing</a></li>
</ul>
<p class="caption"><span class="caption-text">Using the March Exoskeleton</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/high_level_overview.html">High level overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/connecting_to_the_exoskeleton.html">Connecting to the exoskeleton</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/how_to_airgait.html">How to airgait</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/how_to_view_live_data.html">How to view live data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/log_files.html">Log files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/using_the_gait_generator.html">Using the gait generator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/error_codes.html">Error Codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using_the_march_exoskeleton/using_the_pressure_soles.html">Using the pressure soles</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../continuous_integration/continuous_integration.html">Continuous Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/style_guide.html">Style Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/add_a_new_gait.html">Add a new gait</a></li>
</ul>
<p class="caption"><span class="caption-text">March Packages</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="march_data_collector.html">march_data_collector</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_description.html">march_description</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_fake_sensor_data.html">march_fake_sensor_data</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_gait_files.html">march_gait_files</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_hardware.html">march_hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_hardware_builder.html">march_hardware_builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_hardware_interface.html">march_hardware_interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_imu_manager.html">march_imu_manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_input_device.html">march_input_device</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_launch.html">march_launch</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_rqt_input_device.html">march_rqt_input_device</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_rqt_software_check.html">march_rqt_software_check</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">march_safety</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#implementation">Implementation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#error-severity">Error severity</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#warning">Warning</a></li>
<li class="toctree-l3"><a class="reference internal" href="#non-fatal">Non-Fatal</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fatal">Fatal</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ros-api">ROS API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#nodes">Nodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#subscribed-topics">Subscribed Topics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#published-topics">Published Topics</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tutorials">Tutorials</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#add-new-safety-rule-to-existing-safetytype">Add new safety rule to existing SafetyType</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-new-safetytype">Create new SafetyType</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="march_shared_classes.html">march_shared_classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_shared_resources.html">march_shared_resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_state_machine.html">march_state_machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_gait_selection.html">march_gait_selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="march_simulation.html">march_simulation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Project March</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>march_safety</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/project-march/tutorials/blob/master/doc/march_packages/march_safety.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="march-safety">
<span id="march-safety-label"></span><h1>march_safety<a class="headerlink" href="#march-safety" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>March safety is responsible for monitoring the system during run-time. When unexpected behavior is perceived, this
will be logged. Depending on the severity the system can also be stopped or terminated.</p>
<div class="section" id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h3>
<p>March safety consists of a list of <code class="docutils literal"><span class="pre">SafetyType</span></code>-objects. Such an object monitors a part of the system. If a certain condition is
violated, the object will call the <code class="docutils literal"><span class="pre">SafetyHandler</span></code> to invoke an error. The <code class="docutils literal"><span class="pre">SafetyHandler</span></code> is responsible for sending error messages and sounds.
All <code class="docutils literal"><span class="pre">SafetyType</span></code>-objects:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">TemperatureSafety</span></code>, monitors the joint temperatures. Depending on which threshold is exceeded a warning,
non-fatal or fatal is thrown.</li>
<li><code class="docutils literal"><span class="pre">InputDeviceSafety</span></code>, checks if the input device is still connected. Otherwise, a non-fatal is thrown.</li>
</ul>
</div>
</div>
<div class="section" id="error-severity">
<h2>Error severity<a class="headerlink" href="#error-severity" title="Permalink to this headline">¶</a></h2>
<div class="section" id="warning">
<h3>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h3>
<p>This event is a deviation from the normal behavior. However, no extra steps needs to be taken to deal with the consequences.
The system will continue running. The event will only be logged.</p>
</div>
<div class="section" id="non-fatal">
<h3>Non-Fatal<a class="headerlink" href="#non-fatal" title="Permalink to this headline">¶</a></h3>
<p>This event is a deviation from the normal behavior, which has consequences the system should deal with.
A stop message is send indistinguishable from a stop message from an input device.</p>
</div>
<div class="section" id="fatal">
<h3>Fatal<a class="headerlink" href="#fatal" title="Permalink to this headline">¶</a></h3>
<p>This event is an unrecoverable deviation from the normal behavior. There is no (safe) way to make the system behave
properly again. Therefore, the system should terminate.</p>
</div>
</div>
<div class="section" id="ros-api">
<h2>ROS API<a class="headerlink" href="#ros-api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="nodes">
<h3>Nodes<a class="headerlink" href="#nodes" title="Permalink to this headline">¶</a></h3>
<p><em>march_safety</em> - This node reads parameters from the parameter server and runs all <code class="docutils literal"><span class="pre">SafetyType</span></code>-objects.</p>
</div>
<div class="section" id="subscribed-topics">
<h3>Subscribed Topics<a class="headerlink" href="#subscribed-topics" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><em>/march/input_device/alive</em> (<a class="reference external" href="http://docs.ros.org/melodic/api/std_msgs/html/msg/Time.html">std_msgs/Time</a>)</dt>
<dd>Listens to connected input devices and throws an error when an input device lost connection and
logs when a new input device reconnects.</dd>
</dl>
</div>
<div class="section" id="published-topics">
<h3>Published Topics<a class="headerlink" href="#published-topics" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><em>/march/error</em> (<a class="reference external" href="https://github.com/project-march/march/tree/develop/march_shared_resources/msg/Error.msg">march_shared_resources/Error</a>)</dt>
<dd>Publish error for other packages to make it able to respond to errors. This error message is also logged.</dd>
<dt><em>/march/input_device/instruction</em> (<a class="reference external" href="https://github.com/project-march/march/tree/develop/march_shared_resources/msg/GaitInstruction.msg">march_shared_resources/GaitInstruction</a>)</dt>
<dd>Send instructions to the state machine. This topic is only used to send an stop instruction.</dd>
</dl>
</div>
</div>
<div class="section" id="tutorials">
<h2>Tutorials<a class="headerlink" href="#tutorials" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Always add tests when adding code to the <em>march_safety</em> package. Bugs in this package can have dangerous consequences for the system.</p>
</div>
<div class="section" id="add-new-safety-rule-to-existing-safetytype">
<h3>Add new safety rule to existing SafetyType<a class="headerlink" href="#add-new-safety-rule-to-existing-safetytype" title="Permalink to this headline">¶</a></h3>
<p>This is pretty straightforward to do. This tutorial will mostly give remarks and tips:</p>
<ul class="simple">
<li>Add your new rule to the most suited <code class="docutils literal"><span class="pre">SafetyType</span></code>, if no <code class="docutils literal"><span class="pre">SafetyType</span></code> implementations are suited,
create a new one (see <a class="reference internal" href="#march-safety-add-new-rule-label"><span class="std std-ref">Create new SafetyType</span></a>).</li>
<li>When using values that are probably going to change in the future place them as parameter in the
<a class="reference external" href="https://github.com/project-march/march/tree/develop/march_safety/launch/safety_settings.yaml">safety_settings.yaml</a> file. Definitely do this
with values that are probably going to be changed by other team members, by placing the value in the
settings file you make it much easier for them.</li>
<li>It’s possible that the new rule is automatically called, for example because it’s a callback. However, when this is not the case
call the new rule in the <code class="docutils literal"><span class="pre">update</span></code> method of the <code class="docutils literal"><span class="pre">SafetyType</span></code>. This method is executed every cycle of the node.</li>
</ul>
</div>
<div class="section" id="create-new-safetytype">
<span id="march-safety-add-new-rule-label"></span><h3>Create new SafetyType<a class="headerlink" href="#create-new-safetytype" title="Permalink to this headline">¶</a></h3>
<p>For this example we will create a safety type which checks the temperature.</p>
<ul>
<li><p class="first">Set temperature threshold in the <a class="reference external" href="https://github.com/project-march/march/tree/develop/march_safety/launch/safety_settings.yaml">safety_settings.yaml</a> file, this way the threshold is easy to adjust.</p>
</li>
<li><p class="first">Create a class <code class="docutils literal"><span class="pre">TemperatureSafety</span></code> which extends <code class="docutils literal"><span class="pre">SafetyType</span></code></p>
</li>
<li><p class="first">In the constructor of this class you probably want to:</p>
<blockquote>
<div><ul class="simple">
<li>Pass on a pointer to the <code class="docutils literal"><span class="pre">NodeHandle</span></code> and <code class="docutils literal"><span class="pre">SafetyHandle</span></code>.</li>
<li>Obtain the threshold parameter from the parameter service.</li>
</ul>
<div class="code cpp highlight-default"><div class="highlight"><pre><span></span><span class="n">ros</span><span class="p">::</span><span class="n">param</span><span class="p">::</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;~non_fatal_temperature_threshold&quot;</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">non_fatal_temperature_threshold_</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li>Subscribe to the temperature topic.</li>
</ul>
<div class="code cpp highlight-default"><div class="highlight"><pre><span></span><span class="n">ros</span><span class="p">::</span><span class="n">Subscriber</span> <span class="n">subscriber_temperature</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">subscribe</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="p">::</span><span class="n">Temperature</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">&quot;/march/temperature&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">temperatureCallback</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Create a callback method for the temperature subscriber.</p>
<blockquote>
<div><ul class="simple">
<li>In this callback you want to compare the received value with the threshold</li>
</ul>
<div class="code cpp highlight-default"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">temperature</span> <span class="o">&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">non_fatal_temperature_threshold_</span><span class="p">)</span>
<span class="p">{</span>
  <span class="o">//</span> <span class="n">Temperature</span> <span class="n">exceeds</span> <span class="n">threshold</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li>When the threshold is exceeded you probably want to call the non-fatal method from the <code class="docutils literal"><span class="pre">SafetyHandle</span></code>. This is example code:</li>
</ul>
<div class="code cpp highlight-default"><div class="highlight"><pre><span></span><span class="n">this</span><span class="o">-&gt;</span><span class="n">safety_handler_</span><span class="o">-&gt;</span><span class="n">publishNonFatal</span><span class="p">(</span><span class="n">error_message</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">You have to overwrite the <code class="docutils literal"><span class="pre">update</span></code> method from the <code class="docutils literal"><span class="pre">SafetyType</span></code>. However, in this example we are not using the update method.
This method is used when you want to execute some code every <code class="docutils literal"><span class="pre">SafetyNode</span></code> cycle. For example if you want to check if a certain node
is still alive this would be de perfect place to call this code. For this example we will overwrite this method, but keep it empty:</p>
<div class="code cpp highlight-default"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">update</span><span class="p">(</span><span class="n">const</span> <span class="n">ros</span><span class="p">::</span><span class="n">Time</span><span class="o">&amp;</span> <span class="o">/*</span> <span class="n">now</span> <span class="o">*/</span><span class="p">)</span> <span class="n">override</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Finally you need to add the <code class="docutils literal"><span class="pre">TemperatureSafety</span></code> to the <code class="docutils literal"><span class="pre">safety_list</span></code> in the <a class="reference external" href="https://github.com/project-march/march/tree/develop/march_safety/src/safety_node.cpp">safety_node.cpp</a>:</p>
</li>
</ul>
<div class="code cpp highlight-default"><div class="highlight"><pre><span></span><span class="n">safety_list</span><span class="o">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="p">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">TemperatureSafety</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety_handler</span><span class="p">,</span> <span class="n">joint_names</span><span class="p">));</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="march_shared_classes.html" class="btn btn-neutral float-right" title="march_shared_classes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="march_rqt_software_check.html" class="btn btn-neutral float-left" title="march_rqt_software_check" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Project March
      <span class="lastupdated">
        Last updated on Apr 18, 2020.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>